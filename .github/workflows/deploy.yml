name: Build and Deploy to Azure Container Apps

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (default: latest)"
        required: false
        default: "latest"

permissions:
  contents: read
  id-token: write

env:
  RESOURCE_GROUP: sap-services-uk
  LOCATION: eastus
  CONTAINER_APP_ENV: daily-checks-env
  CONTAINER_APP_NAME: daily-checks-audit
  IMAGE_NAME: daily-checks-audit
  PERSON_RESPONSIBLE_TAG: joyee.sen@softwareone.com
  ACR_NAME: sapservicesuk
  ACR_LOGIN_SERVER: sapservicesuk.azurecr.io
  ALLOW_HOST: "" # optional; leave empty to auto-derive FQDN

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Docker login
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.ACR_LOGIN_SERVER }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}

      - name: Build and push image
        env:
          IMAGE_TAG: ${{ github.event.inputs.image_tag || 'latest' }}
        run: |
          set -euo pipefail
          IMAGE_REF="$ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG"
          echo "Building $IMAGE_REF"
          docker build -t "$IMAGE_REF" .
          echo "Pushing $IMAGE_REF"
          docker push "$IMAGE_REF"
          echo "IMAGE_REF=$IMAGE_REF" >> $GITHUB_ENV

      - name: Ensure resource group with required tag
        run: |
          az group create --name "$RESOURCE_GROUP" --location "$LOCATION" --tags PersonResponsible="$PERSON_RESPONSIBLE_TAG"
          az group update --name "$RESOURCE_GROUP" --set tags.PersonResponsible="$PERSON_RESPONSIBLE_TAG"

      - name: Ensure Container Apps environment
        run: |
          az containerapp env create \
            --name "$CONTAINER_APP_ENV" \
            --resource-group "$RESOURCE_GROUP" \
            --location "$LOCATION" \
            --only-show-errors

      - name: Create or update Container App
        env:
          IMAGE_TAG: ${{ github.event.inputs.image_tag || 'latest' }}
          ACR_USERNAME: ${{ secrets.USERNAME }}
          ACR_PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          set -euo pipefail
          IMAGE_REF="$ACR_LOGIN_SERVER/$IMAGE_NAME:$IMAGE_TAG"

          ENV_ARGS=()
          if [ -n "$ALLOW_HOST" ]; then
            ENV_ARGS+=("--set-env-vars" "MCP_ALLOWED_HOSTS=$ALLOW_HOST" "MCP_ALLOWED_ORIGINS=https://$ALLOW_HOST")
          fi

          if az containerapp show --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP" --only-show-errors > /dev/null 2>&1; then
            echo "Updating existing container app..."
            if [ ${#ENV_ARGS[@]} -gt 0 ]; then
              az containerapp update \
                --name "$CONTAINER_APP_NAME" \
                --resource-group "$RESOURCE_GROUP" \
                --image "$IMAGE_REF" \
                --set-env-vars "${ENV_ARGS[@]:1}" \
                --only-show-errors
            else
              az containerapp update \
                --name "$CONTAINER_APP_NAME" \
                --resource-group "$RESOURCE_GROUP" \
                --image "$IMAGE_REF" \
                --only-show-errors
            fi
          else
            echo "Creating container app..."
            az containerapp create \
              --name "$CONTAINER_APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --environment "$CONTAINER_APP_ENV" \
              --image "$IMAGE_REF" \
              --ingress external \
              --target-port 8000 \
              --registry-server "$ACR_LOGIN_SERVER" \
              --registry-username "$ACR_USERNAME" \
              --registry-password "$ACR_PASSWORD" \
              ${ENV_ARGS[@]} \
              --only-show-errors
          fi

          echo "Ensuring ingress external:8000..."
          az containerapp ingress set \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --type external \
            --target-port 8000 \
            --only-show-errors

          if [ -z "$ALLOW_HOST" ]; then
            FQDN=$(az containerapp show --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP" --query "properties.configuration.ingress.fqdn" -o tsv)
            echo "Setting allowlist to $FQDN"
            az containerapp update \
              --name "$CONTAINER_APP_NAME" \
              --resource-group "$RESOURCE_GROUP" \
              --set-env-vars "MCP_ALLOWED_HOSTS=$FQDN" "MCP_ALLOWED_ORIGINS=https://$FQDN" \
              --only-show-errors
          fi

      - name: Show deployed FQDN
        run: |
          FQDN=$(az containerapp show --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP" --query "properties.configuration.ingress.fqdn" -o tsv)
          echo "Deployed FQDN: $FQDN"
